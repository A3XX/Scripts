# Check BitLocker status of operating system drive
$osDriveStatus = Get-BitLockerVolume -MountPoint "C:" | Select-Object -ExpandProperty ProtectionStatus

# Check if operating system drive is encrypted
if ($osDriveStatus -eq "FullyEncrypted") {
    Write-Host "All drives are already encrypted. Exiting script."
    Exit
}

# Encrypt the operating system drive if not encrypted
if ($osDriveStatus -ne "FullyEncrypted") {
    Write-Host "Encrypting operating system drive..."
    Enable-BitLocker -MountPoint "C:" -UsedSpaceOnly -SkipHardwareTest -RecoveryPasswordProtector
}

# Loop through fixed drives and encrypt if not encrypted
$fixedDrives = Get-WmiObject -Class Win32_LogicalDisk -Filter "DriveType=3"
foreach ($drive in $fixedDrives) {
    $driveLetter = $drive.DeviceID

    $driveStatus = Get-BitLockerVolume -MountPoint $driveLetter | Select-Object -ExpandProperty ProtectionStatus

    if ($driveStatus -ne "FullyEncrypted") {
        Write-Host "Encrypting drive $driveLetter..."
        Enable-BitLocker -MountPoint $driveLetter -UsedSpaceOnly -SkipHardwareTest -RecoveryPasswordProtector
    }
}

# Enable BitLocker auto-unlock for non-operating system drives
$nonOsDrives = $fixedDrives | Where-Object { $_.DeviceID -ne "C:" }
foreach ($drive in $nonOsDrives) {
    $driveLetter = $drive.DeviceID
    Write-Host "Enabling BitLocker auto-unlock for drive $driveLetter..."
    Enable-BitLockerAutoUnlock -MountPoint $driveLetter
}
